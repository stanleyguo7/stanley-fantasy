from pathlib import Path

OUT = Path('docs/worldviews/events')


def write_file(name, title, intro, events):
    lines = [f"# 事件库｜{title}（重写版·时间序）\n", intro, "\n---\n"]
    for i, e in enumerate(events, 1):
        lines.append(f"### 事件 {i:02d}｜{e['name']}")
        lines.append(f"- **剧情设定**：{e['setup']}")
        lines.append(f"- **主要角色**：{e['roles']}")
        lines.append("- **剧情发展**：")
        for j, step in enumerate(e['dev'], 1):
            lines.append(f"  {j}. {step}")
        lines.append(f"- **小角色卷入点**：{e['hook']}\n")
    (OUT / name).write_text("\n".join(lines), encoding='utf-8')


def ev(name, setup, roles, dev, hook):
    return {"name": name, "setup": setup, "roles": roles, "dev": dev, "hook": hook}

# 08 Harry Potter canon-oriented (books 1-7 timeline + social aftermath)
hp = []
hp.append(ev("哈利进入魔法世界（1991）","哈利收到霍格沃茨录取信，魔法与麻瓜世界边界首次被亲历打破。","哈利、海格、麦格、德思礼一家",["对角巷购物建立魔法社会日常感","分院前的身份偏见开始显影","霍格沃茨成为主舞台","三人组关系萌芽","校内与校外叙事正式并轨"],"新生、图书馆助理、宿舍级长、商店学徒"))
hp.append(ev("魔法石争夺与伏地魔回影","学校内部异常与禁区秘密牵引出魔法石主线。","哈利、赫敏、罗恩、斯内普、奇洛",["禁区线索不断增多","三人组越界调查","关卡式挑战推进","奇洛现身与伏地魔寄生揭露","魔法界暂得喘息"],"巡夜学生、禁林护送、学院计分员"))
hp.append(ev("密室开启与蛇怪袭击（1992）","霍格沃茨连发石化事件，纯血主义话术重新抬头。","哈利、金妮、汤姆·里德尔日记、洛哈特",["受害者增加引发恐慌","学院间敌意上升","密室传说被证实","蛇怪被击败、日记伏笔成立","校方治理与舆论修复"],"医务室值班、校刊记者、走廊巡查"))
hp.append(ev("阿兹卡班逃犯传闻（1993）","布莱克越狱打破‘摄魂怪威慑秩序’，学校安全逻辑改变。","小天狼星、卢平、斯内普、摄魂怪",["摄魂怪进驻校园周边","哈利与守护神训练","真凶认知被反转","彼得逃逸留下长期风险","魔法部公信力受损"],"列车护卫、课堂旁听、医疗救助"))
hp.append(ev("三强争霸赛重启（1994）","国际合作赛事成为伏地魔复活的政治掩体。","哈利、塞德里克、穆迪（假）、伏地魔",["赛事制造跨校联盟与竞争","线索误导与操纵并行","墓地仪式导致伏地魔复活","塞德里克死亡成为代际创伤","魔法部否认危机"],"赛事后勤、看台安保、记者团实习"))
hp.append(ev("魔法部否认战争与乌姆里奇入校（1995）","官僚系统以秩序名义压制真相，校园治理政治化。","乌姆里奇、邓布利多、哈利、DA成员",["预言家日报舆论战升级","黑魔法防御课被阉割","DA地下教学建立","神秘事务司战斗爆发","伏地魔公开现身，否认破产"],"社团联络员、违纪记录员、报社投递员"))
hp.append(ev("混血王子笔记与魂器线索（1996）","战前一年进入情报与暗杀并行阶段。","邓布利多、斯内普、马尔福、哈利",["斯拉格霍恩记忆成为关键情报","马尔福执行渗透任务","天文塔之夜邓布利多遇刺","凤凰社进入紧急状态","学校由教育中心转为战时据点"],"医疗翼协助、塔楼巡逻、仓库管理员"))
hp.append(ev("七个波特与撤离战（1997）","哈利成年前夜，反伏地魔力量全面转入地下。","哈利、疯眼汉、韦斯莱家族、食死徒",["撤离行动被提前截击","护送线多点失守","魔法部迅速沦陷","麻瓜出身登记制度展开","战争由前线扩展至日常"],"撤离路线引导、避难屋维护、身份文件伪造协助"))
hp.append(ev("霍格沃茨大战（1998）","决战在学校爆发，旧秩序与新秩序完成交接。","哈利、伏地魔、麦格、斯内普、纳威",["城堡防御体系启动","魂器逐一摧毁","斯内普记忆揭示长期真相","伏地魔阵营崩解","战后重建开启"],"城堡防线民兵、伤员转运、战后遗体登记"))
# add extended post-war 31 events
for i in range(10, 61):
    phase = "战后修复" if i < 30 else ("制度重塑" if i < 46 else "代际传承")
    hp.append(ev(f"{phase}节点{i}",
        "围绕战争后果、教育改革、法律追责与记忆修复，魔法社会进入漫长再建过程。",
        "魔法部改革派、霍格沃茨教师团、圣芒戈治疗师、审判庭成员",
        ["旧案重审与证词冲突并发","幸存者心理创伤进入公共议题","学院与部委博弈课程和规则边界","地方社群形成新的互助网络","代际叙事从英雄史转向普通人修复史"],
        "档案整理员、听证记录员、校务志愿者、社区治疗项目协助者"))
write_file('08-harry-potter-events.md','哈利波特范式（原著主线+战后延展，60事件）','> 以原著七部曲主线为骨架，后续补入战后制度与社会修复事件，保证世界观连续性。',hp)

# 06 射雕
sd=[]
anchors=[
"靖康国难余波","牛家村旧案","江南七怪远赴蒙古","郭靖在草原成长","黄河四鬼与初入中原","华山论剑余绪","桃花岛线索","赵王府冲突","郭靖黄蓉相识","中都与太湖博弈","洪七公传艺","欧阳锋布局","铁枪庙旧怨","丐帮大会与权柄","完颜洪烈势力扩张","蒙古南侵前夜","岳王庙与民族大义","郭靖守襄阳意志形成","再访桃花岛","一灯线与因果补偿"
]
for idx,a in enumerate(anchors,1):
    sd.append(ev(f"主线锚点{idx}：{a}","围绕《射雕英雄传》人物关系与家国背景推进，江湖恩怨与宋金蒙格局并行。","郭靖、黄蓉、杨康、洪七公、欧阳锋、黄药师",["旧案或新冲突触发行动","门派/家族立场发生对冲","武学传承与政治选择交织","关键人物关系重排","为后续大战埋下因果"],"客栈耳目、镖局趟子手、丐帮外围弟子、城防民兵"))
for i in range(21,66):
    phase="江湖线深化" if i<40 else ("家国线升温" if i<55 else "终局余波")
    sd.append(ev(f"{phase}事件{i}","事件围绕帮会秩序、武学秘籍争夺与边地军情扩散展开。","帮主、护法、边将、行商、地方豪强",["地方纠纷被上层势力利用","情报在驿路与酒肆传播","师门立场影响个人命运","冲突在擂台/城防/渡口三线升级","阶段性平衡后再次破局"],"行脚郎中、驿站马夫、码头账房、军需搬运者"))
write_file('06-legend-of-condor-heroes-events.md','射雕英雄传范式（65事件）','> 以《射雕》核心人物与宋金蒙格局为主，强化江湖-家国双线。',sd)

# 07 笑傲
xa=[]
anchors=["福威镖局灭门","辟邪剑谱争夺","华山内部权力结构裂变","令狐冲逐出师门","思过崖武学遗刻","日月神教权斗","任我行脱困","左冷禅并派计划","五岳剑派大会","东方不败时代秩序","恒山接掌与江湖评价战","黑木崖决战"]
for i,a in enumerate(anchors,1):
    xa.append(ev(f"主线锚点{i}：{a}","事件贴合《笑傲江湖》‘名门正派叙事与权力现实错位’主题。","令狐冲、岳不群、林平之、任盈盈、左冷禅、任我行",["表面正义叙事占据舆论","隐秘利益链推动下一步冲突","个人情义与组织纪律撕裂","关键秘籍/掌门位引发站队","旧秩序被迫重写"],"镖局伙计、山门杂役、情报跑腿、会盟场务"))
for i in range(13,61):
    phase="门派秩序崩塌" if i<30 else ("江湖重排" if i<46 else "新秩序磨合")
    xa.append(ev(f"{phase}事件{i}","围绕并派、叛门、复仇与舆论争夺，江湖进入长期不信任状态。","各派掌门、客卿、散人剑客、票号东家",["传闻先行导致误判","门规被选择性执行","关键人物借危机巩固权力","旧案翻出重构关系网络","短暂停战后再度破裂"],"驿站信使、山道向导、票号文书、药铺学徒"))
write_file('07-smiling-proud-wanderer-events.md','笑傲江湖范式（60事件）','> 严格围绕门派政治、秘籍与名实冲突，强调江湖秩序如何被权力改写。',xa)

# 现代与历史现实向：更细时间浪潮

def generic_real(title, filename, epochs, roles):
    events=[]
    idx=1
    for ep in epochs:
        for k in range(ep['count']):
            events.append(ev(f"{ep['name']}·节点{k+1}", ep['setup'], ep['roles'], [
                "宏观政策或社会风向变化先到达基层", "家庭与职业选择被迫重估", "地方执行出现差异与摩擦", "个体通过迁移、转岗或再学习应对", "阶段秩序重新稳定并遗留新问题"
            ], ep['hook']))
            idx+=1
    write_file(filename,title,f"> 以时代结构变化为主轴，强调普通人在制度与市场波动中的被动与能动。",events)


generic_real('当代中国（2020s，62事件）','01-contemporary-china-2020s-events.md',[
    {"name":"平台社会深化","count":12,"setup":"移动互联网平台渗透到就业、消费、教育与公共服务。","roles":"平台从业者、社区干部、中小学教师、新市民家庭","hook":"网格员、骑手站点调度、社区志愿者"},
    {"name":"行业重估与就业重排","count":14,"setup":"多行业进入监管与结构调整周期，就业预期波动。","roles":"中层管理者、转岗青年、小店经营者、人力从业者","hook":"招聘助理、技能培训班班委、工友互助群"},
    {"name":"家庭照护与教育焦虑再平衡","count":12,"setup":"家庭在生育、养老、教育之间重新分配资源与时间。","roles":"双职工家庭、祖辈照护者、校方管理者、社工","hook":"家委会联络员、社区托育志愿者"},
    {"name":"AI进入日常协作","count":14,"setup":"AI工具广泛进入办公、内容、服务场景，岗位能力模型变化。","roles":"产品经理、设计师、文员、培训讲师","hook":"数据标注员、流程测试员、课程助教"},
    {"name":"长期主义与地方生活重建","count":10,"setup":"部分人从高压竞争回流到地方生活与长期积累路径。","roles":"返乡青年、县域创业者、基层医生、文化工作者","hook":"县城活动策划、合作社记账、社区健康项目"}
],[])

# fix roles parameter misuse by rewriting function call above not used; already passed roles string in epoch.
# 80s 58

generic_real('中国80年代（58事件）','02-china-1980s-events.md',[
    {"name":"改革起步与观念松动","count":12,"setup":"生产责任制与地方试点逐步改变‘单位-家庭’关系。","roles":"国营厂职工、乡镇干部、返乡青年、教师","hook":"供销社搬运、广播站记录员"},
    {"name":"个体经济萌芽","count":12,"setup":"个体经营逐步被接受，稳定岗位与市场冒险并存。","roles":"个体摊主、厂办干部、街道管理者、手工业者","hook":"摊位协管、进货跟车员"},
    {"name":"城乡流动加快","count":12,"setup":"务工与求学流动扩大，家庭结构和地方秩序重塑。","roles":"进城务工者、乡镇教师、车站职工、户籍民警","hook":"车站引导员、合租房管理员"},
    {"name":"文化消费与青年表达","count":11,"setup":"文艺热与新媒介传播改变青年身份认同。","roles":"文艺青年、报刊编辑、文化馆干部、校园社团","hook":"海报张贴员、演出场务"},
    {"name":"代际协商与新秩序","count":11,"setup":"家庭围绕婚恋、职业与居住展开新一轮协商。","roles":"父母辈工人、青年职员、社区调解员、厂医","hook":"居委会记录员、婚庆筹备协助"}
],[])

# 90s 60

generic_real('中国90年代（60事件）','03-china-1990s-events.md',[
    {"name":"市场化提速","count":12,"setup":"价格与流通体系市场化推进，机会与风险同步放大。","roles":"个体老板、国企职工、批发市场商户、记者","hook":"货运跟车员、摊位会计"},
    {"name":"国企转轨与身份再造","count":14,"setup":"下岗分流与再就业成为家庭核心议题。","roles":"转岗职工、再就业服务中心、家属院居民、技校教师","hook":"再就业登记员、技能班学员"},
    {"name":"南下潮与沿海制造链","count":12,"setup":"大量劳动力向沿海工厂聚集，形成新型工友网络。","roles":"产线班组长、新工人、宿舍管理员、劳务中介","hook":"宿舍楼层长、夜班物资员"},
    {"name":"媒体与消费社会扩张","count":11,"setup":"电视广告、品牌消费与城市商业空间重塑日常。","roles":"销售员、广告业务员、商场经理、消费者组织","hook":"促销活动执行、仓储盘点员"},
    {"name":"世纪交替预热","count":11,"setup":"互联网萌芽与教育扩招预期改变青年路径。","roles":"网吧经营者、中学生、大学辅导员、电脑店老板","hook":"机房维护、报名志愿者"}
],[])

# 五代十国 56
ft=[]
for i in range(1,57):
    phase = "后梁后唐更替" if i<=12 else ("中原频替与南方割据" if i<=30 else ("贸易韧性与地方秩序" if i<=44 else "宋前整合前夜"))
    ft.append(ev(f"{phase}·事件{i}","政权更替频仍，城池归属和军镇忠诚不断变化，地方社会在战乱与交易间求生。","节度使、州县官、商帮领袖、寺院僧录、城防将校",[
        "上级政权更替引发地方重新站队","粮道、盐道与水运成为争夺核心","文书与税册频繁重编造成社会摩擦","军镇与商帮临时结盟维持秩序","阶段稳定后再被下一轮战事打破"],"漕运书手、城门税吏、商队护卫、寺院账房"))
write_file('05-five-dynasties-ten-kingdoms-events.md','五代十国（56事件）','> 突出“政权高频更替+地方社会自我修复”的时代质地。',ft)

print('done')
